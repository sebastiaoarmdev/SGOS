/* Criação de tabelas - Firebird 4.0 */

/* CLIENTE */
CREATE TABLE CLIENTE (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR(120) COLLATE UNICODE_CI_AI NOT NULL,
    DOCUMENTO VARCHAR(20),
    EMAIL VARCHAR(120),
    TELEFONE VARCHAR(30),
    DATA_CADASTRO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    /* Regras de validação simples */
    CHECK (EMAIL LIKE '%@%.%'),
    CHECK (TELEFONE SIMILAR TO '[0-9]+')
);

/* ORDEM DE SERVIÇO */
CREATE TABLE ORDEM_SERVICO (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CLIENTE_ID INTEGER NOT NULL,
    DATA_ABERTURA DATE NOT NULL,
    DATA_PREVISTA DATE,
    DATA_FECHAMENTO DATE,
    STATUS VARCHAR(15) NOT NULL, /* Aberta, Em Andamento, Concluída, Cancelada */
    DESCRICAO_PROBLEMA VARCHAR(500),
    VALOR_TOTAL NUMERIC(15,2) DEFAULT 0,

    /* Chave estrangeira */
    CONSTRAINT FK_OS_CLIENTE FOREIGN KEY (CLIENTE_ID) REFERENCES CLIENTE(ID),

    /* Apenas valores válidos */
    CHECK (STATUS IN ('Aberta', 'Em Andamento', 'Concluída', 'Cancelada'))
);

/* ITEM DA ORDEM */
CREATE TABLE ITEM_ORDEM (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ORDEM_ID INTEGER NOT NULL,
    DESCRICAO VARCHAR(200) NOT NULL,
    QUANTIDADE NUMERIC(12,2) NOT NULL,
    VALOR_UNITARIO NUMERIC(15,2) NOT NULL,

    /* Chave estrangeira */
    CONSTRAINT FK_ITEM_ORDEM FOREIGN KEY (ORDEM_ID) REFERENCES ORDEM_SERVICO(ID),

    /* Não permite valores inválidos */
    CHECK (QUANTIDADE > 0),
    CHECK (VALOR_UNITARIO >= 0)
);

/* ===================== */
/* ÍNDICES AUXILIARES    */
/* ===================== */

/* Pesquisa rápida por status */
CREATE INDEX IDX_OS_STATUS ON ORDEM_SERVICO (STATUS);

/* Pesquisa rápida por cliente */
CREATE INDEX IDX_OS_CLIENTE ON ORDEM_SERVICO (CLIENTE_ID);

/* Pesquisa rápida por data de abertura */
CREATE INDEX IDX_OS_DATA_ABERTURA ON ORDEM_SERVICO (DATA_ABERTURA);

/* Filtro combinado (status + data) */
CREATE INDEX IDX_OS_STATUS_DATA_ABERTURA ON ORDEM_SERVICO (STATUS, DATA_ABERTURA);

/* ===================== */
/* VIEW PARA RELATÓRIOS  */
/* ===================== */

CREATE OR ALTER VIEW VW_OS_RESUMO AS
SELECT 
    O.ID,
    O.CLIENTE_ID,
    C.NOME AS CLIENTE_NOME,
    O.DATA_ABERTURA,
    O.DATA_PREVISTA,
    O.DATA_FECHAMENTO,
    O.STATUS,
    O.VALOR_TOTAL,
    CASE
        WHEN (O.STATUS NOT IN ('Concluída', 'Cancelada'))
             AND (O.DATA_PREVISTA IS NOT NULL)
             AND (CURRENT_DATE > O.DATA_PREVISTA)
        THEN 1 ELSE 0
    END AS EM_ATRASO
FROM ORDEM_SERVICO O
JOIN CLIENTE C ON C.ID = O.CLIENTE_ID;